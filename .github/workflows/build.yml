name: Build AetherOnePy Executable with Plugins

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      # ... (your existing inputs) ...

env:
  PYTHON_VERSION: '3.11'
  PYINSTALLER_VERSION: '6.14.2'
  PLUGIN_DIR: 'py/plugins'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install PyInstaller and base dependencies
      run: |
        pip install --upgrade pip
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        # Install dependencies from setup.py
        pip install -e ./py

    - name: Prepare plugin directory
      run: |
        mkdir -p ${{ env.PLUGIN_DIR }}

    - name: Clone AetherOne Social Plugin
      run: |
        git clone https://github.com/emolionl/AetherOnePySocialPlugin.git ${{ env.PLUGIN_DIR }}/AetherOnePySocialPlugin

    - name: Clone Financial Compass Plugin
      run: |
        git clone https://github.com/emolionl/FinCompassPlugin.git ${{ env.PLUGIN_DIR }}/FinCompassPlugin

    - name: Build UI (Angular)
      run: |
        cd ui
        npm install
        npm run build -- --base-href=/
        cd ..

    - name: Build Executable
      run: |
        pyinstaller AetherOnePy.spec --noconfirm --log-level INFO

    # ... (rest of your release and upload steps remain the same) ...
    - name: Create release with plugins
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: AetherOnePy with Plugins ${{ github.ref_name }}
        body: |
          ## üöÄ AetherOnePy Desktop Application with Plugins
          This release includes the complete AetherOnePy application with all configured plugins.
          
          ### üì¶ What's Included
          - ‚úÖ Complete desktop application
          - ‚úÖ All enabled plugins from the `plugins-config.json`
          - ‚úÖ Plugin dependencies automatically resolved
          - ‚úÖ Data components and rates database
          
          ### üõ†Ô∏è Installation
          1. Download `AetherOnePy-WithPlugins-ci.zip` from the assets below.
          2. Extract the contents and run `AetherOnePy.exe`.
          
          ---
          Built automatically with GitHub Actions ü§ñ
        files: |
          AetherOnePy-WithPlugins-ci.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}